<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Services\AutentiqueService;
use App\Services\TemplateProcessor;
use App\Models\CorretorAkad;
use Exception;

class TesteAutentiqueCommand extends Command
{
    /**
     * The name and signature of the console command.
     */
    protected $signature = 'autentique:test 
                           {--template-only : Testa apenas o processamento de templates}
                           {--skip-api : Pula testes que requerem API}';

    /**
     * The console command description.
     */
    protected $description = 'Testa a integra√ß√£o completa do sistema Autentique com templates HTML';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info('üß™ Iniciando testes do sistema Autentique...');
        
        $sucessos = 0;
        $falhas = 0;

        // Teste 1: TemplateProcessor
        if ($this->testeTemplateProcessor()) {
            $sucessos++;
        } else {
            $falhas++;
        }

        // Teste 2: AutentiqueService configura√ß√£o
        if (!$this->option('skip-api')) {
            if ($this->testeAutentiqueConfig()) {
                $sucessos++;
            } else {
                $falhas++;
            }
        }

        // Teste 3: Processamento completo (sem envio)
        if ($this->testeProcessamentoCompleto()) {
            $sucessos++;
        } else {
            $falhas++;
        }

        // Teste 4: Valida√ß√µes
        if ($this->testeValidacoes()) {
            $sucessos++;
        } else {
            $falhas++;
        }

        $this->newLine();
        $this->info("üìä Resumo dos testes:");
        $this->line("   ‚úÖ Sucessos: {$sucessos}");
        $this->line("   ‚ùå Falhas: {$falhas}");

        if ($falhas === 0) {
            $this->info('üéâ Todos os testes passaram!');
            return Command::SUCCESS;
        } else {
            $this->error('üí• Alguns testes falharam. Verifique os logs acima.');
            return Command::FAILURE;
        }
    }

    /**
     * Teste do TemplateProcessor
     */
    protected function testeTemplateProcessor()
    {
        $this->newLine();
        $this->info('üîß Testando TemplateProcessor...');

        try {
            $processor = new TemplateProcessor();

            // Teste 1: Listar templates
            $templates = $processor->listTemplates();
            $this->line("   üìÑ Templates encontrados: " . count($templates));

            if (empty($templates)) {
                $this->warn('   ‚ö†Ô∏è Nenhum template encontrado');
                return false;
            }

            // Teste 2: Validar template principal
            $templatePrincipal = 'declaracao-akad-template.html';
            
            if (!$processor->templateExists($templatePrincipal)) {
                $this->error("   ‚ùå Template principal n√£o encontrado: {$templatePrincipal}");
                return false;
            }

            $this->line("   ‚úÖ Template principal encontrado: {$templatePrincipal}");

            // Teste 3: Extrair vari√°veis
            $variaveis = $processor->getTemplateVariables($templatePrincipal);
            $this->line("   üî§ Vari√°veis encontradas: " . implode(', ', $variaveis));

            $variaveisEsperadas = ['CIDADE', 'DATA', 'NOME_CORRETORA', 'CODIGO_SUSEP', 'CNPJ_CORRETORA', 'DATA_GERACAO'];
            $variaveisFaltantes = array_diff($variaveisEsperadas, $variaveis);

            if (!empty($variaveisFaltantes)) {
                $this->warn("   ‚ö†Ô∏è Vari√°veis esperadas n√£o encontradas: " . implode(', ', $variaveisFaltantes));
            }

            // Teste 4: Processar template
            $dadosTeste = [
                'CIDADE' => 'S√£o Paulo',
                'DATA' => '15/10/2025',
                'NOME_CORRETORA' => 'Jo√£o Silva Corretor',
                'CODIGO_SUSEP' => 'SP.123456',
                'CNPJ_CORRETORA' => '12.345.678/0001-90',
                'DATA_GERACAO' => '15/10/2025 10:30:00'
            ];

            $resultado = $processor->processTemplate($templatePrincipal, $dadosTeste);

            if ($resultado['success']) {
                $this->line("   ‚úÖ Template processado com sucesso");
                $this->line("   üìÅ Arquivo tempor√°rio: " . $resultado['file_name']);
                
                // Limpar arquivo tempor√°rio
                $processor->deleteTempFile($resultado['file_path']);
                $this->line("   üóëÔ∏è Arquivo tempor√°rio removido");
                
                return true;
            } else {
                $this->error("   ‚ùå Erro ao processar template: " . $resultado['error']);
                return false;
            }

        } catch (Exception $e) {
            $this->error("   üí• Exce√ß√£o: {$e->getMessage()}");
            return false;
        }
    }

    /**
     * Teste da configura√ß√£o do AutentiqueService
     */
    protected function testeAutentiqueConfig()
    {
        $this->newLine();
        $this->info('‚öôÔ∏è Testando configura√ß√£o do AutentiqueService...');

        try {
            $service = new AutentiqueService();
            $config = $service->validarConfiguracao();

            if ($config['valido']) {
                $this->line("   ‚úÖ Configura√ß√£o v√°lida");
                return true;
            } else {
                $this->error("   ‚ùå Problemas na configura√ß√£o:");
                foreach ($config['erros'] as $erro) {
                    $this->line("      - {$erro}");
                }
                return false;
            }

        } catch (Exception $e) {
            $this->error("   üí• Exce√ß√£o: {$e->getMessage()}");
            return false;
        }
    }

    /**
     * Teste do processamento completo (sem envio real)
     */
    protected function testeProcessamentoCompleto()
    {
        $this->newLine();
        $this->info('üîÑ Testando processamento completo...');

        try {
            // Criar um corretor fict√≠cio para teste
            $corretorTeste = new CorretorAkad([
                'nome' => 'Maria Silva Testes',
                'email' => 'maria.teste@example.com',
                'cpf' => '123.456.789-00',
                'creci' => '123456',
                'estado' => 'SP',
                'telefone' => '(11) 99999-9999'
            ]);
            $corretorTeste->id = 999999; // ID fict√≠cio

            try {
                $service = new AutentiqueService();
                
                // Teste apenas a gera√ß√£o do HTML (m√©todo protegido, ent√£o vamos testar indiretamente)
                $this->line("   üë§ Corretor de teste criado: {$corretorTeste->nome}");
                $this->line("   üìß Email: {$corretorTeste->email}");
                $this->line("   üÜî CRECI: {$corretorTeste->creci} - {$corretorTeste->estado}");

                // Validar que o service foi criado corretamente
                $templates = $service->listarTemplates();
                
                if ($templates['success']) {
                    $count = count($templates['templates']);
                    $this->line("   üìÑ Templates carregados pelo service: {$count}");
                    return true;
                } else {
                    $this->error("   ‚ùå Erro ao listar templates: " . $templates['error']);
                    return false;
                }
            } catch (Exception $e) {
                if (strpos($e->getMessage(), 'Token do Autentique n√£o configurado') !== false) {
                    $this->warn("   ‚ö†Ô∏è Token n√£o configurado (esperado): {$e->getMessage()}");
                    $this->line("   ‚úÖ Teste de processamento conclu√≠do (sem token)");
                    return true;
                } else {
                    throw $e;
                }
            }

        } catch (Exception $e) {
            $this->error("   üí• Exce√ß√£o: {$e->getMessage()}");
            return false;
        }
    }

    /**
     * Teste das valida√ß√µes
     */
    protected function testeValidacoes()
    {
        $this->newLine();
        $this->info('‚úÖ Testando valida√ß√µes...');

        try {
            $processor = new TemplateProcessor();
            
            // Teste 1: Template inexistente
            $resultado = $processor->processTemplate('template-inexistente.html', []);
            if (!$resultado['success']) {
                $this->line("   ‚úÖ Valida√ß√£o de template inexistente funcionando");
            } else {
                $this->error("   ‚ùå Valida√ß√£o de template inexistente falhou");
                return false;
            }

            // Teste 2: Vari√°veis faltantes
            if ($processor->templateExists('declaracao-akad-template.html')) {
                $resultado = $processor->processTemplate('declaracao-akad-template.html', []);
                if (!$resultado['success'] && strpos($resultado['error'], 'obrigat√≥rias n√£o fornecidas') !== false) {
                    $this->line("   ‚úÖ Valida√ß√£o de vari√°veis obrigat√≥rias funcionando");
                } else {
                    $this->error("   ‚ùå Valida√ß√£o de vari√°veis obrigat√≥rias falhou");
                    return false;
                }
            }

            // Teste 3: Limpeza autom√°tica
            try {
                $service = new AutentiqueService();
                $deletados = $service->limpezaAutomatica();
                $this->line("   üßπ Limpeza autom√°tica executada: {$deletados} arquivos removidos");
            } catch (Exception $e) {
                if (strpos($e->getMessage(), 'Token do Autentique n√£o configurado') !== false) {
                    $this->warn("   ‚ö†Ô∏è Limpeza autom√°tica pulada (token n√£o configurado)");
                    
                    // Teste direto do TemplateProcessor
                    $processor = new TemplateProcessor();
                    $deletados = $processor->cleanupOldTempFiles();
                    $this->line("   üßπ Limpeza direta executada: {$deletados} arquivos removidos");
                } else {
                    throw $e;
                }
            }

            return true;

        } catch (Exception $e) {
            $this->error("   üí• Exce√ß√£o: {$e->getMessage()}");
            return false;
        }
    }
}